--- ../src-base/minecraft/net/minecraft/client/settings/GameSettings.java
+++ ../src-work/minecraft/net/minecraft/client/settings/GameSettings.java
@@ -20,7 +20,7 @@
 import java.util.Map;
 import java.util.Set;
 import net.minecraft.client.Minecraft;
-import net.minecraft.client.gui.GuiNewChat;
+import net.pl3x.client.gui.GuiChatWindow;
 import net.minecraft.client.gui.chat.NarratorChatListener;
 import net.minecraft.client.renderer.texture.TextureMap;
 import net.minecraft.client.resources.I18n;
@@ -107,6 +107,10 @@
     public float field_96692_F = 1.0F;
     public float field_96693_G = 0.44366196F;
     public float field_96694_H = 1.0F;
+    public float chatBGRed = 51;
+    public float chatBGGreen = 102;
+    public float chatBGBlue = 153;
+    public float chatBGAlpha = 128;
     public int field_151442_I = 4;
     private final Map<SoundCategory, Float> field_186714_aM = Maps.newEnumMap(SoundCategory.class);
     public boolean field_181150_U = true;
@@ -165,6 +169,7 @@
 
     public GameSettings(Minecraft p_i46326_1_, File p_i46326_2_)
     {
+        setForgeKeybindProperties();
         this.field_74324_K = (KeyBinding[])ArrayUtils.addAll(new KeyBinding[] {this.field_74312_F, this.field_74313_G, this.field_74351_w, this.field_74370_x, this.field_74368_y, this.field_74366_z, this.field_74314_A, this.field_74311_E, this.field_151444_V, this.field_74316_C, this.field_151445_Q, this.field_74310_D, this.field_74321_H, this.field_74322_I, this.field_74323_J, this.field_151447_Z, this.field_151457_aa, this.field_151458_ab, this.field_152395_am, this.field_178883_an, this.field_186718_X, this.field_193629_ap, this.field_193630_aq, this.field_194146_ao}, this.field_151456_ac);
         this.field_74318_M = EnumDifficulty.NORMAL;
         this.field_74332_R = "";
@@ -188,6 +193,7 @@
 
     public GameSettings()
     {
+        setForgeKeybindProperties();
         this.field_74324_K = (KeyBinding[])ArrayUtils.addAll(new KeyBinding[] {this.field_74312_F, this.field_74313_G, this.field_74351_w, this.field_74370_x, this.field_74368_y, this.field_74366_z, this.field_74314_A, this.field_74311_E, this.field_151444_V, this.field_74316_C, this.field_151445_Q, this.field_74310_D, this.field_74321_H, this.field_74322_I, this.field_74323_J, this.field_151447_Z, this.field_151457_aa, this.field_151458_ab, this.field_152395_am, this.field_178883_an, this.field_186718_X, this.field_193629_ap, this.field_193630_aq, this.field_194146_ao}, this.field_151456_ac);
         this.field_74318_M = EnumDifficulty.NORMAL;
         this.field_74332_R = "";
@@ -262,33 +268,57 @@
         if (p_74304_1_ == GameSettings.Options.CHAT_OPACITY)
         {
             this.field_74357_r = p_74304_2_;
-            this.field_74317_L.field_71456_v.func_146158_b().func_146245_b();
+            this.field_74317_L.field_71456_v.getChatGUI().refreshChat();
         }
 
         if (p_74304_1_ == GameSettings.Options.CHAT_HEIGHT_FOCUSED)
         {
             this.field_96694_H = p_74304_2_;
-            this.field_74317_L.field_71456_v.func_146158_b().func_146245_b();
+            this.field_74317_L.field_71456_v.getChatGUI().refreshChat();
         }
 
         if (p_74304_1_ == GameSettings.Options.CHAT_HEIGHT_UNFOCUSED)
         {
             this.field_96693_G = p_74304_2_;
-            this.field_74317_L.field_71456_v.func_146158_b().func_146245_b();
+            this.field_74317_L.field_71456_v.getChatGUI().refreshChat();
         }
 
         if (p_74304_1_ == GameSettings.Options.CHAT_WIDTH)
         {
             this.field_96692_F = p_74304_2_;
-            this.field_74317_L.field_71456_v.func_146158_b().func_146245_b();
+            this.field_74317_L.field_71456_v.getChatGUI().refreshChat();
         }
 
         if (p_74304_1_ == GameSettings.Options.CHAT_SCALE)
         {
             this.field_96691_E = p_74304_2_;
-            this.field_74317_L.field_71456_v.func_146158_b().func_146245_b();
+            this.field_74317_L.field_71456_v.getChatGUI().refreshChat();
         }
 
+        if (p_74304_1_ == GameSettings.Options.CHAT_BG_RED)
+        {
+            this.chatBGRed = p_74304_2_;
+            this.field_74317_L.field_71456_v.getChatGUI().refreshChat();
+        }
+
+        if (p_74304_1_ == GameSettings.Options.CHAT_BG_GREEN)
+        {
+            this.chatBGGreen = p_74304_2_;
+            this.field_74317_L.field_71456_v.getChatGUI().refreshChat();
+        }
+
+        if (p_74304_1_ == GameSettings.Options.CHAT_BG_BLUE)
+        {
+            this.chatBGBlue = p_74304_2_;
+            this.field_74317_L.field_71456_v.getChatGUI().refreshChat();
+        }
+
+        if (p_74304_1_ == GameSettings.Options.CHAT_BG_ALPHA)
+        {
+            this.chatBGAlpha = p_74304_2_;
+            this.field_74317_L.field_71456_v.getChatGUI().refreshChat();
+        }
+
         if (p_74304_1_ == GameSettings.Options.MIPMAP_LEVELS)
         {
             int i = this.field_151442_I;
@@ -299,7 +329,7 @@
                 this.field_74317_L.func_147117_R().func_147633_a(this.field_151442_I);
                 this.field_74317_L.func_110434_K().func_110577_a(TextureMap.field_110575_b);
                 this.field_74317_L.func_147117_R().func_174937_a(false, this.field_151442_I > 0);
-                this.field_74317_L.func_175603_A();
+                this.needsResourceRefresh = true; // FORGE: fix for MC-64581 very laggy mipmap slider
             }
         }
 
@@ -513,6 +543,22 @@
         {
             return this.field_96692_F;
         }
+        else if (p_74296_1_ == GameSettings.Options.CHAT_BG_RED)
+        {
+            return this.chatBGRed;
+        }
+        else if (p_74296_1_ == GameSettings.Options.CHAT_BG_GREEN)
+        {
+            return this.chatBGGreen;
+        }
+        else if (p_74296_1_ == GameSettings.Options.CHAT_BG_BLUE)
+        {
+            return this.chatBGBlue;
+        }
+        else if (p_74296_1_ == GameSettings.Options.CHAT_BG_ALPHA)
+        {
+            return this.chatBGAlpha;
+        }
         else if (p_74296_1_ == GameSettings.Options.FRAMERATE_LIMIT)
         {
             return (float)this.field_74350_i;
@@ -644,16 +690,32 @@
             }
             else if (p_74297_1_ == GameSettings.Options.CHAT_HEIGHT_UNFOCUSED)
             {
-                return s + GuiNewChat.func_146243_b(f) + "px";
+                return s + GuiChatWindow.calculateChatboxHeight(f) + "px";
             }
             else if (p_74297_1_ == GameSettings.Options.CHAT_HEIGHT_FOCUSED)
             {
-                return s + GuiNewChat.func_146243_b(f) + "px";
+                return s + GuiChatWindow.calculateChatboxHeight(f) + "px";
             }
             else if (p_74297_1_ == GameSettings.Options.CHAT_WIDTH)
             {
-                return s + GuiNewChat.func_146233_a(f) + "px";
+                return s + GuiChatWindow.calculateChatboxWidth(f) + "px";
             }
+            else if (p_74297_1_ == GameSettings.Options.CHAT_BG_RED)
+            {
+                return s + "#" + floatToHex4(chatBGRed) + " (" + (int)chatBGRed + ")";
+            }
+            else if (p_74297_1_ == GameSettings.Options.CHAT_BG_GREEN)
+            {
+                return s + "#" + floatToHex4(chatBGGreen) + " (" + (int)chatBGGreen + ")";
+            }
+            else if (p_74297_1_ == GameSettings.Options.CHAT_BG_BLUE)
+            {
+                return s + "#" + floatToHex4(chatBGBlue) + " (" + (int)chatBGBlue + ")";
+            }
+            else if (p_74297_1_ == GameSettings.Options.CHAT_BG_ALPHA)
+            {
+                return s + "#" + floatToHex4(chatBGAlpha) + " (" + (int)chatBGAlpha + ")";
+            }
             else if (p_74297_1_ == GameSettings.Options.RENDER_DISTANCE)
             {
                 return s + I18n.func_135052_a("options.chunks", (int)f1);
@@ -934,6 +996,26 @@
                         this.field_74357_r = this.func_74305_a(s2);
                     }
 
+                    if ("chatBGRed".equals(s1))
+                    {
+                        this.chatBGRed = this.func_74305_a(s2);
+                    }
+
+                    if ("chatBGGreen".equals(s1))
+                    {
+                        this.chatBGGreen = this.func_74305_a(s2);
+                    }
+
+                    if ("chatBGBlue".equals(s1))
+                    {
+                        this.chatBGBlue = this.func_74305_a(s2);
+                    }
+
+                    if ("chatBGAlpha".equals(s1))
+                    {
+                        this.chatBGAlpha = this.func_74305_a(s2);
+                    }
+
                     if ("snooperEnabled".equals(s1))
                     {
                         this.field_74355_t = "true".equals(s2);
@@ -1068,7 +1150,12 @@
                     {
                         if (s1.equals("key_" + keybinding.func_151464_g()))
                         {
-                            keybinding.func_151462_b(Integer.parseInt(s2));
+                            if (s2.indexOf(':') != -1)
+                            {
+                                String[] t = s2.split(":");
+                                keybinding.setKeyModifierAndCode(net.minecraftforge.client.settings.KeyModifier.valueFromString(t[1]), Integer.parseInt(t[0]));
+                            } else
+                            keybinding.setKeyModifierAndCode(net.minecraftforge.client.settings.KeyModifier.NONE, Integer.parseInt(s2));
                         }
                     }
 
@@ -1132,6 +1219,7 @@
 
     public void func_74303_b()
     {
+        if (net.minecraftforge.fml.client.FMLClientHandler.instance().isLoading()) return;
         PrintWriter printwriter = null;
 
         try
@@ -1175,6 +1263,10 @@
             printwriter.println("chatLinks:" + this.field_74359_p);
             printwriter.println("chatLinksPrompt:" + this.field_74358_q);
             printwriter.println("chatOpacity:" + this.field_74357_r);
+            printwriter.println("chatBGRed:" + this.chatBGRed);
+            printwriter.println("chatBGGreen:" + this.chatBGGreen);
+            printwriter.println("chatBGBlue:" + this.chatBGBlue);
+            printwriter.println("chatBGAlpha:" + this.chatBGAlpha);
             printwriter.println("snooperEnabled:" + this.field_74355_t);
             printwriter.println("fullscreen:" + this.field_74353_u);
             printwriter.println("enableVsync:" + this.field_74352_v);
@@ -1206,7 +1298,8 @@
 
             for (KeyBinding keybinding : this.field_74324_K)
             {
-                printwriter.println("key_" + keybinding.func_151464_g() + ":" + keybinding.func_151463_i());
+                String keyString = "key_" + keybinding.func_151464_g() + ":" + keybinding.func_151463_i();
+                printwriter.println(keybinding.getKeyModifier() != net.minecraftforge.client.settings.KeyModifier.NONE ? keyString + ":" + keybinding.getKeyModifier() : keyString);
             }
 
             for (SoundCategory soundcategory : SoundCategory.values())
@@ -1342,7 +1435,11 @@
         SHOW_SUBTITLES("options.showSubtitles", false, true),
         REALMS_NOTIFICATIONS("options.realmsNotifications", false, true),
         AUTO_JUMP("options.autoJump", false, true),
-        NARRATOR("options.narrator", false, false);
+        NARRATOR("options.narrator", false, false),
+        CHAT_BG_RED("options.chat.bg.red", true, false, 0, 255, 1),
+        CHAT_BG_GREEN("options.chat.bg.green", true, false, 0, 255, 1),
+        CHAT_BG_BLUE("options.chat.bg.blue", true, false, 0, 255, 1),
+        CHAT_BG_ALPHA("options.chat.bg.alpha", true, false, 0, 255, 1);
 
         private final boolean field_74385_A;
         private final boolean field_74386_B;
@@ -1440,4 +1537,39 @@
             return p_148264_1_;
         }
     }
+
+    /******* Forge Start ***********/
+    private void setForgeKeybindProperties() {
+        net.minecraftforge.client.settings.KeyConflictContext inGame = net.minecraftforge.client.settings.KeyConflictContext.IN_GAME;
+        field_74351_w.setKeyConflictContext(inGame);
+        field_74370_x.setKeyConflictContext(inGame);
+        field_74368_y.setKeyConflictContext(inGame);
+        field_74366_z.setKeyConflictContext(inGame);
+        field_74314_A.setKeyConflictContext(inGame);
+        field_74311_E.setKeyConflictContext(inGame);
+        field_151444_V.setKeyConflictContext(inGame);
+        field_74312_F.setKeyConflictContext(inGame);
+        field_74310_D.setKeyConflictContext(inGame);
+        field_74321_H.setKeyConflictContext(inGame);
+        field_74323_J.setKeyConflictContext(inGame);
+        field_151457_aa.setKeyConflictContext(inGame);
+        field_151458_ab.setKeyConflictContext(inGame);
+        field_186718_X.setKeyConflictContext(inGame);
+    }
+
+    // FORGE: fix for MC-64581 very laggy mipmap slider
+    private boolean needsResourceRefresh = false;
+    public void onGuiClosed()
+    {
+        if (needsResourceRefresh)
+        {
+            this.field_74317_L.func_175603_A();
+            this.needsResourceRefresh = false;
+        }
+    }
+
+    public static String floatToHex4(float f) {
+        return (f <= 16 ? "0" : "") + Integer.toString((int)f, 16);
+    }
+    /******* Forge End ***********/
 }
